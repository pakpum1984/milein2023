<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>บันทึกไมล์เข้า</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css">
  <link href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.dataTables.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/js/all.min.js" crossorigin="anonymous"></script>
 
  <style>
    body {
      font-family: "Prompt", sans-serif;
      font-weight: bold;
      font-size: 12px;
      background-color: #f8f9fa;
    }
    .spinner-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%; 
    } 
    .modal-content {
      border-radius: 10px; 
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    #dataTablemilein th {
      background-color: green; /* สีเฮดเดอร์datatable */
      color: #ffffff; /* สีข้อความในเฮดเดอร์datatable */
    }
    .form-control {
      border-radius: 5px;
      border: 1px solid #ced4da;
    }
    .btn-primary {
      background-color: #0d6efd;
      border: none;
      border-radius: 5px;
      padding: 8px 16px;
    }
    .btn-secondary {
      background-color: #6c757d;
      border: none;
      border-radius: 5px;
      padding: 8px 16px;
    }
    .btn-primary:hover, .btn-secondary:hover {
      opacity: 0.9;
    }
    .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .table-hover tbody tr:hover {
      background-color: rgba(0, 0, 0, 0.075);
    }
  </style>
</head>

<body>
  <div class="modal fade" id="editModal1" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="editModalLabel">บันทึกไมล์เข้า</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
              <div class="modal-body">
          <form id="myFormsave1" onsubmit="saveChangesToSpreadsheet1(event)" class="row g-2">

              <input type="text" class="form-control" id="editId1" readonly hidden>

           <div class="col-12 col-md-6 mb-2">
              <label for="editNamebook" class="form-label">ชื่อผู้จอง:</label>
              <input type="text" class="form-control" id="editNamebook1" name="editNamebook1" style="color: blue;">
            </div>
            <div class="col-3 col-md-3 mb-2">
              <label for="editDepbook" class="form-label">แผนก:</label>
              <input type="text" class="form-control" id="editDepbook1" name="editDepbook1" style="color: blue;">
            </div>
            <div class="col-3 col-md-3 mb-2">
              <label for="editCarbook" class="form-label">รถที่จอง</label>
              <input type="text" class="form-control" id="editCarbook1" name="editCarbook1" style="color: blue;">
            </div>
                  <div class="col-6 col-md-6 mb-2">
              <label for="editDriver" class="form-label">ชื่อคนขับ</label>
              <input type="text" class="form-control" id="editDriver1" name="editDriver1" style="color: blue;" required>
            </div>
            <div class="col-12 col-md-6 mb-2">
              <label for="editLocabook" class="form-label">สถานที่ๆไปติดต่อ</label>
              <input type="text" class="form-control" id="editLocabook1" name="editLocabook1" style="color: blue;">
            </div>

              <input type="date" class="form-control" id="editDateoutbook1" name="editDateoutbook1" style="display: none;">

              <input type="text" class="form-control" id="editTimeoutbook1" name="editTimeoutbook1" style="display: none;">
              
              <input type="date" class="form-control" id="editDateinbook1" name="editDateinbook1" style="display: none;">
            
              <input type="text" class="form-control" id="editTimeinbook1" name="editTimeinbook1" style="display: none;">


              <input type="text" class="form-control" id="editDrivebook1" name="editDrivebook1" style="display: none;">



              <input type="text" class="form-control" id="editStatusbook1" name="editStatusbook1" value="ส่งคืน" style="display: none;">


              <input type="text" class="form-control" id="editApproverbook1" name="editApproverbook1" style="display: none;">
             <input type="text" class="form-control" id="editDateout1" name="editDateout1"  style="display: none;">
              <input type="text" class="form-control" id="editTimeout1" name="editTimeout1" style="display: none;" >
<!--             <input type="text" class="form-control" id="editMileout1" name="editMileout1" style="display: none;"> -->
            <div class="col-6 col-md-6 mb-2">
              <label for="editDateout" class="form-label">วันที่เข้า</label>
              <input type="date" class="form-control" id="editDatein1" name="editDatein1" style="color: blue;">
            </div>
           <div class="col-6 col-md-6 mb-2">
              <label for="editTimeout" class="form-label">เวลาเข้า</label>
              <input type="time" class="form-control" id="editTimein1" name="editTimein1" style="color: blue;">
            </div>
 
     
            <div class="col-6 col-md-6 mb-2">
              <label for="editMileout" class="form-label">เลขไมล์ออก</label>
              <input type="tel" class="form-control" id="editMileout1" name="editMileout1" style="color: blue;">
            </div>
                       <div class="col-6 col-md-6 mb-2">
              <label for="editMileout" class="form-label">เลขไมล์เข้า</label>
              <input type="tel" class="form-control" id="editMilein1" name="editMilein1" style="color: blue;">
            </div>
            <div class="col-12 col-md-12 mb-2">
              <label for="editOtherbook" class="form-label">อื่นๆ</label>
              <input type="text" class="form-control" id="editOtherbook1" name="editOtherbook1" style="color: blue;">
            </div>
       

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
          <button type="submit" class="btn btn-success" onclick="saveChangesToSpreadsheet1(event)">บันทึก</button>
           </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid mt-4">
    <div class="card shadow">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">แบบฟอร์มบันทึกไมล์เข้า</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table id="dataTablemilein" class="table table-striped table-hover table-bordered" style="width:100%">
            <thead class="bg-secondary text-white"></thead>
          </table>
        </div>
      </div>
    </div>
  </div>
<br>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/sheetrock@1.2.0/dist/sheetrock.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script>
    // ดึงเวลาปัจจุบันขึ้นมาแสดง
    var now = new Date();
    var hours = String(now.getHours()).padStart(2, '0');
    var minutes = String(now.getMinutes()).padStart(2, '0');
    var currentTimeuser = hours + ':' + minutes;
    document.getElementById('editTimein1').value = currentTimeuser;
    
       function getCurrentDate() {
        var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var yyyy = today.getFullYear();
        return yyyy + '-' + mm + '-' + dd;
    }

    // กำหนดค่าเริ่มต้นให้ input[type="date"]
    var todayDate = getCurrentDate();
    document.getElementById('editDatein1').value = todayDate;
    document.getElementById('editDatein1').min = todayDate;



    var googleScriptUrl = 'https://script.google.com/macros/s/AKfycbxut1SLegvjLl9cu80T14Miyf-v1FeU_IMW3ZKQz_LSLx4dPijl7x4gy3iJBKL5saU_CA/exec'; // ใส่ URL ของ Google Apps Script ที่คุณสร้าง
    var mySpreadsheet1 = 'https://docs.google.com/spreadsheets/d/1JXBX3BUeCMyFvAIZQwjd_LDLVhhnxq4RmP6N37Pgokw/edit?gid=682820549#gid=682820549';

    $(document).ready(function() {
      $('#dataTablemilein').html('<div class="spinner-container" id="hidespinner"><div class="spinner-border text-success me-2" style="width: 40px; height: 40px;" role="status"></div> กำลังโหลดข้อมูลไมล์เข้า...</div>');

      $('#dataTablemilein').sheetrock({
        url: mySpreadsheet1,
        query: ("select A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R offset 0"),
      }).on('sheetrock:loaded', function () {
        
        $('#hidespinner').hide();
        
           // ตรวจสอบว่ามีข้อมูลหรือไม่
    if ($('#dataTablemilein tr').length <= 1) { // ถ้ามีแค่ header หรือไม่มีข้อมูลเลย
      $('#dataTablemilein').html('<p class="text-center text-danger mt-3">ไม่มีข้อมูล!!!</p>');
      return; // จบการทำงาน ไม่ต้องสร้าง DataTable
    }
        
        $(this).DataTable({
          dom: 't',
          info: true,
          responsive: true,
          lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "all"]],
          order: [[5, 'asc'], [6, 'asc']],
          destroy: true,
          columnDefs: [
            {targets: [1,4,5,6, 17], className: 'all'},
          ],
          columns: [
            { title: 'ไอดี'},
            { title: 'ชื่อผู้จอง'},
            { title: 'แผนก'},
            { title: 'รถที่จอง'},
            { title: 'สถานที่ๆไปติดต่อ'},
            { title: 'วันที่ใช้รถ'},
            { title: 'ออกเวลา'},
            { title: 'วันที่เข้า'},
            { title: 'เข้าเวลา' },
            { title: 'สถานะการขับ'},
            { title: 'อื่นๆ'},
            { title: 'สถานะการจอง'},
            { title: 'ผู้อนุมัติ'},
            { title: 'วันที่ออก'},
            { title: 'เวลาออก'},
            { title: 'เลขไมล์ออก'},
            { title: 'ผู้ขับขี่'},
            { title: 'Edit',
              targets: 17,
              data: null,
              defaultContent: '<i class="fa-solid fa-pen-to-square fa-2xl" style="color: green; cursor: pointer;" data-toggle="modal" data-target="#editModal1" onclick="editData1(this);"></i>',
            },
          ],
        });
      });
    });


  function editData1(element) {
      var rowData = $(element).closest('tr').find('td').map(function() {
        return $(this).text();
      }).get();
console.log(rowData);  // ตรวจสอบข้อมูลที่ถูกดึงมา
      var id1 = rowData[0];
      var editNamebook1 = rowData[1];
      var editDepbook1 = rowData[2];
      var editCarbook1 = rowData[3];
      var editLocabook1 = rowData[4];
      var editDateoutbook1 = rowData[5];
      var editTimeoutbook1 = rowData[6];
      var editDateinbook1 = rowData[7];
      var editTimeinbook1 = rowData[8];
      var editDrivebook1 = rowData[9];
      var editOtherbook1 = rowData[10];
      var editStatusbook1 = rowData[11];
      var editApproverbook1 = rowData[12];
      var editDateout1 = rowData[13];
      var editTimeout1 = rowData[14];
      var editMileout1 = rowData[15];
      var editDriver1 = rowData[16];
  
     

      $('#editId1').val(id1); // แก้ไขตรงนี้ให้กำหนดค่า id ไม่ใช่ editedIdnum

      $('#editNamebook1').val(editNamebook1);
      $('#editDepbook1').val(editDepbook1);
      $('#editCarbook1').val(editCarbook1);
      $('#editLocabook1').val(editLocabook1);
      $('#editDateoutbook1').val(editDateoutbook1);
      $('#editTimeoutbook1').val(editTimeoutbook1);
      $('#editDateinbook1').val(editDateinbook1);
      $('#editTimeinbook1').val(editTimeinbook1);
      $('#editDrivebook1').val(editDrivebook1);
      $('#editOtherbook1').val(editOtherbook1);
     // $('#editStatusbook1').val(editStatusbook1);
      $('#editApproverbook1').val(editApproverbook1);
      $('#editDateout1').val(editDateout1);
      $('#editTimeout1').val(editTimeout1);
      $('#editMileout1').val(editMileout1);
      $('#editDriver1').val(editDriver1);
    
    
      $('#editModal1').modal('show');
  }

  function saveChangesToSpreadsheet1(event) {
      event.preventDefault(); // Prevent the default form submission
      Swal.fire({
          position: 'center',
          title: '<h4>กำลังบันทึกข้อมูล...</h4>',
          showConfirmButton: false,
      })
      Swal.showLoading();
      var editedIdnum1 = $('#editId1').val();
      var editNamebook1 = $('#editNamebook1').val();
      var editDepbook1 = $('#editDepbook1').val();
      var editCarbook1 = $('#editCarbook1').val();
      var editLocabook1 = $('#editLocabook1').val();
      var editDateoutbook1 = $('#editDateoutbook1').val();
      var editTimeoutbook1 = $('#editTimeoutbook1').val();
    var editDateinbook1 = $('#editDateinbook1').val();
      var editTimeinbook1 = $('#editTimeinbook1').val();
      var editDrivebook1 = $('#editDrivebook1').val();
      var editOtherbook1 = $('#editOtherbook1').val();
      var editStatusbook1 = $('#editStatusbook1').val();
      var editApproverbook1 = $('#editApproverbook1').val();
      var editDateout1 = $('#editDateout1').val();
      var editTimeout1 = $('#editTimeout1').val();
      var editMileout1 = $('#editMileout1').val();
      var editDatein1 = $('#editDatein1').val();
      var editTimein1 = $('#editTimein1').val();
      var editMilein1 = $('#editMilein1').val();
      var editDriver1 = $('#editDriver1').val();
      
      if (editTimeout1 == "") {
      Swal.fire({
        position: 'center',
        icon: 'error',
        title: '<h4>กรุณากรอกเวลาออก</h4>',
        showConfirmButton: true,
        confirmButtonText: 'OK',
      });
      return;
    } else if (editMileout1 == "") {
      Swal.fire({
        position: 'center',
        icon: 'error',
        title: '<h4>กรุณากรอกเลขไมล์ออก</h4>',
        showConfirmButton: true,
        confirmButtonText: 'OK',
      });
      return;
    }  else if (editDriver1 == "") {
      Swal.fire({
        position: 'center',
        icon: 'error',
        title: '<h4>กรุณาระบุชื่อคนขับ</h4>',
        showConfirmButton: true,
        confirmButtonText: 'OK',
      });
      return;
    }


      // ในการเรียกใช้ AJAX request ควรใช้ idnum ที่เป็นตัวแปรที่ได้จากการคลิกแก้ไขข้อมูล ไม่ใช่จาก $(this)
      var editId1  = $('#editId1').val();

      $.ajax({
          url: googleScriptUrl,
          method: 'POST',
          dataType: 'json',
          data: {
      

        id1: editedIdnum1,
        editNamebook1: editNamebook1,
        editDepbook1: editDepbook1,
        editCarbook1: editCarbook1,
        editLocabook1: editLocabook1,
        editDateoutbook1: editDateoutbook1,
        editTimeoutbook1: editTimeoutbook1,
        editDateinbook1: editDateinbook1,
        editTimeinbook1: editTimeinbook1,
        editDrivebook1: editDrivebook1,
        editOtherbook1: editOtherbook1,
        editStatusbook1: editStatusbook1,
        editApproverbook1: editApproverbook1,
        editDateout1: editDateout1,
        editTimeout1: editTimeout1,
        editMileout1: editMileout1,
        editDatein1: editDatein1,
        editTimein1: editTimein1,
        editMilein1: editMilein1,
        editDriver1: editDriver1
          },
          success: function(response) {
            console.log(response)
            if (response == true) {
             
                Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: '<h4>บันทึกข้อมูลสำเร็จ</h4>',
                    showConfirmButton: false,
                    timer: 1500,
                });
              location.reload();
               document.getElementById("myFormsave1").reset();
            }
          },
          error: function(error) {
              console.error('Error saving data:', error);
          }
      });

      // Close the modal
      $('#editModal1').modal('hide');
  }


</script>
  
   
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  </body>


</html>
